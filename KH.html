<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ - ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</title>
    <style>
        :root {
            --bg-color: #0f0f0f;
            --chat-bg: #1a1a1a;
            --my-msg-bg: #ff6b00; /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            --other-msg-bg: #2d2d2d;
            --text-color: #ffffff;
            --text-muted: #b0b0b0;
            --border-color: #444;
            --input-bg: #000;
            --success-color: #00e676;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Arial Black', sans-serif; /* Ø®Ø· Ø¹Ø±ÙŠØ¶ */
            font-weight: 700;
            -webkit-tap-highlight-color: transparent; /* Ø¥Ø²Ø§Ù„Ø© Ù„ÙˆÙ† Ø§Ù„Ù†Ù‚Ø± Ø§Ù„Ø£Ø²Ø±Ù‚ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh; /* Ù…Ù„Ø¡ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ */
            height: 100dvh; /* Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙŠØ« */
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© --- */
        header {
            background-color: var(--chat-bg);
            padding: 10px 15px;
            border-bottom: 2px solid var(--my-msg-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            flex-shrink: 0; /* Ù…Ù†Ø¹ Ø§Ù„ØªØ±ÙˆÙŠØ³Ø© Ù…Ù† Ø§Ù„Ø§Ù†ÙƒÙ…Ø§Ø´ */
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .dev-info-btn {
            background: transparent;
            border: 1px solid var(--my-msg-bg);
            color: var(--my-msg-bg);
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: 0.3s;
        }
        .dev-info-btn:hover { background: var(--my-msg-bg); color: white; }

        .clock {
            font-family: 'Courier New', monospace;
            color: var(--text-muted);
            font-size: 0.9rem;
            background: #000;
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }

        .app-title {
            color: var(--my-msg-bg);
            font-size: 1.1rem;
            text-shadow: 0 0 5px rgba(255, 107, 0, 0.4);
        }

        /* --- Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ --- */
        .dev-modal {
            display: none;
            position: absolute;
            top: 60px;
            left: 10px;
            background: var(--chat-bg);
            border: 2px solid var(--my-msg-bg);
            padding: 15px;
            border-radius: 8px;
            width: 240px;
            z-index: 100;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .dev-modal.show { display: block; animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* --- Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† --- */
        .online-bar {
            background: #151515;
            padding: 8px 15px;
            font-size: 0.85rem;
            color: var(--success-color);
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            overflow-x: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--success-color);
            border-radius: 50%;
            display: inline-block;
            box-shadow: 0 0 5px var(--success-color);
        }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© --- */
        #chat-container {
            flex: 1; /* ØªØ£Ø®Ø° ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ§Ø­Ø© */
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            min-height: 0; /* Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„ÙÙ„ÙŠÙƒØ³ Ø¨ÙˆÙƒØ³ */
        }

        .message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 15px;
            position: relative;
            word-wrap: break-word;
            animation: slideUp 0.3s ease;
            border: 1px solid var(--border-color);
        }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .msg-sender {
            font-size: 0.8rem;
            margin-bottom: 5px;
            opacity: 0.8;
            display: block;
        }

        .msg-cashier {
            align-self: flex-end; /* ÙŠÙ…ÙŠÙ† */
            background: var(--my-msg-bg);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .msg-staff {
            align-self: flex-start; /* ÙŠØ³Ø§Ø± */
            background: var(--other-msg-bg);
            color: white;
            border-bottom-left-radius: 2px;
        }

        .msg-img {
            max-width: 100%;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #555;
            display: block;
        }

        /* Ø²Ø± Ø§Ù„Ø±Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© (ØªÙ… ØªØ­Ø¬ÙŠÙ…Ù‡) */
        .reply-btn-inline {
            display: block;
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--my-msg-bg);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            text-align: center;
        }
        .reply-btn-inline:active { background: var(--my-msg-bg); }

        .reply-data {
            background: rgba(0,0,0,0.2);
            padding: 8px;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 0.95rem;
        }
        .reply-data span { color: var(--success-color); }

        /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙÙ„ÙŠØ© --- */
        .input-area {
            background: var(--chat-bg);
            padding: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: center;
            flex-shrink: 0; /* Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            font-size: 1rem; /* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø®Ø· */
            flex-shrink: 0;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--my-msg-bg); box-shadow: 0 0 10px rgba(255, 107, 0, 0.3); }
        .btn-secondary { background: #333; }
        
        /* --- Ø´Ø§Ø´Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-color);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-card {
            background: var(--chat-bg);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid var(--my-msg-bg);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .role-tabs {
            display: flex;
            margin-bottom: 20px;
            background: #000;
            border-radius: 8px;
            padding: 5px;
        }

        .role-tab {
            flex: 1;
            padding: 10px;
            cursor: pointer;
            border-radius: 5px;
            color: var(--text-muted);
            transition: 0.3s;
        }
        .role-tab.active { background: var(--my-msg-bg); color: white; }

        .form-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            border-radius: 8px;
            text-align: center;
            font-size: 1.1rem;
        }
        .form-input:focus { outline: none; border-color: var(--my-msg-bg); }

        /* --- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…ÙˆØ¯Ø§Ù„ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¬Ù…) --- */
        .camera-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #000;
            z-index: 40;
            flex-direction: column; /* Ø¹Ù…ÙˆØ¯ÙŠ */
            justify-content: space-between; /* Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙŠØ£Ø®Ø° Ù…Ø³Ø§Ø­ØªÙ‡ØŒ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
        }
        .camera-overlay.active { display: flex; }
        
        .video-wrapper {
            flex: 1; /* ÙŠØ£Ø®Ø° Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; /* Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„ÙƒØ§Ù…Ù„ Ø¯ÙˆÙ† Ù‚Øµ */
            max-height: 100%;
        }

        .camera-controls {
            padding: 20px;
            background: rgba(0,0,0,0.8); /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© Ù„Ù„Ø£Ø²Ø±Ø§Ø± */
            display: flex;
            justify-content: space-around;
            width: 100%;
            position: relative;
            z-index: 45;
            gap: 15px;
        }

        .camera-controls .btn {
            flex: 1; /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ£Ø®Ø° Ø¹Ø±Ø¶ Ù…ØªØ³Ø§Ùˆ */
            font-size: 1.1rem;
        }

        .reply-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: var(--chat-bg);
            border: 2px solid var(--my-msg-bg);
            padding: 20px;
            border-radius: 10px;
            z-index: 60;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .reply-modal.active { display: block; }

    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-screen">
        <div class="login-card">
            <h2 style="color: var(--my-msg-bg); margin-bottom: 20px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <div class="role-tabs">
                <div class="role-tab active" id="tab-cashier" onclick="switchLoginRole('cashier')">ÙƒØ§Ø´ÙŠØ±</div>
                <div class="role-tab" id="tab-staff" onclick="switchLoginRole('staff')">Ù…ÙˆØ¸Ù Ù…Ø¨ÙŠØ¹Ø§Øª</div>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ÙƒØ§Ø´ÙŠØ± -->
            <div id="form-cashier">
                <input type="password" id="cashier-pass" class="form-input" placeholder="Ø§Ø¯Ø®Ù„  ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn btn-primary" style="width:100%" onclick="loginCashier()">Ø¯Ø®ÙˆÙ„</button>
            </div>

            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù…ÙˆØ¸Ù -->
            <div id="form-staff" style="display:none;">
                <label style="display:block; margin-bottom:10px; color:var(--text-muted);">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ</label>
                <input type="text" id="staff-name-input" class="form-input" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ø§Ø³Ù… Ù‡Ù†Ø§" autocomplete="off">
                <button class="btn btn-primary" style="width:100%" onclick="loginStaff()">Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <header>
        <div class="header-left">
            <button class="dev-info-btn" onclick="toggleDevInfo()">i</button>
            <div class="app-title">Ù†Ø¸Ø§Ù… Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</div>
        </div>
        <div class="clock" id="clock">--:--:--</div>
        
        <!-- Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ -->
        <div id="dev-modal" class="dev-modal">
            <h3 style="color: var(--my-msg-bg);">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬</h3>
            <p style="margin: 10px 0;">ÙŠÙ…Ø§Ù† Ù…Ø­Ù…Ø¯ Ø­Ø³ÙŠÙ†</p>
            <p style="direction: ltr; font-family: monospace; margin-bottom: 10px;">0952725590</p>
            <button class="btn btn-secondary" style="width:100%; font-size:0.8rem;" onclick="toggleDevInfo()">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </header>

    <div class="online-bar">
        <span class="online-dot"></span>
        <span id="online-users-text">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ØªØµÙ„ÙŠÙ†...</span>
    </div>

    <div id="chat-container">
        <!-- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ -->
        <div style="text-align: center; color: #555; margin-top: 50px;">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ ØºØ±ÙØ© Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</div>
    </div>

    <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø£Ø³ÙÙ„) -->
    <div class="input-area" id="cashier-tools" style="display:none;">
        <button class="btn btn-primary" style="flex:1;" onclick="openCamera()">ğŸ“· ØªØµÙˆÙŠØ± Ù…Ù†ØªØ¬</button>
    </div>

    <!-- ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„ÙƒØ§Ø´ÙŠØ± -->
    <div class="camera-overlay" id="camera-ui">
        <div class="video-wrapper">
            <video id="video-feed" autoplay playsinline></video>
        </div>
        <div class="camera-controls">
            <button class="btn btn-secondary" onclick="closeCamera()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" onclick="captureAndSend()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³ØªØ¹Ù„Ø§Ù…</button>
        </div>
        <canvas id="canvas-feed" style="display:none;"></canvas>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„Ù…ÙˆØ¸Ù -->
    <div class="reply-modal" id="reply-modal">
        <h3 style="color: var(--my-msg-bg); margin-bottom: 15px;">Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</h3>
        <input type="text" id="reply-code" class="form-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªØ¬">
        <input type="text" id="reply-price" class="form-input" placeholder="Ø§Ù„Ø³Ø¹Ø±">
        <div style="display: flex; gap: 10px; margin-top: 15px;">
            <button class="btn btn-secondary" style="flex:1;" onclick="closeReplyModal()">Ø¥Ù„ØºØ§Ø¡</button>
            <button class="btn btn-primary" style="flex:1;" onclick="sendReply()">Ø¥Ø±Ø³Ø§Ù„</button>
        </div>
    </div>

    <script>
        // --- Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
        let currentUser = null;
        let userRole = null; // 'cashier' or 'staff'
        let stream = null;
        let replyingToMsgId = null;
        
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- Ø§Ù„Ø³Ø§Ø¹Ø© ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('en-US');
        }
        setInterval(updateClock, 1000);
        updateClock();

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¨Ø±Ù…Ø¬ ---
        function toggleDevInfo() {
            document.getElementById('dev-modal').classList.toggle('show');
        }
        window.onclick = function(e) {
            const modal = document.getElementById('dev-modal');
            const btn = document.querySelector('.dev-info-btn');
            if (e.target != modal && e.target != btn && !modal.contains(e.target)) {
                modal.classList.remove('show');
            }
        }

        // --- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
        function switchLoginRole(role) {
            document.querySelectorAll('.role-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${role}`).classList.add('active');
            
            if (role === 'cashier') {
                document.getElementById('form-cashier').style.display = 'block';
                document.getElementById('form-staff').style.display = 'none';
            } else {
                document.getElementById('form-cashier').style.display = 'none';
                document.getElementById('form-staff').style.display = 'block';
            }
        }

        function loginCashier() {
            const pass = document.getElementById('cashier-pass').value;
            if (pass === '1992') {
                userRole = 'cashier';
                currentUser = 'Ø§Ù„ÙƒØ§Ø´ÙŠØ±';
                enterApp();
            } else {
                alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        }

        function loginStaff() {
            const nameInput = document.getElementById('staff-name-input');
            const name = nameInput.value.trim();

            if (name === "") {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            userRole = 'staff';
            currentUser = name;
            enterApp();
        }

        function enterApp() {
            document.getElementById('login-screen').style.display = 'none';
            if (userRole === 'cashier') {
                document.getElementById('cashier-tools').style.display = 'flex';
            }
            loadMessages();
            startPresence();
        }

        // --- Ù†Ø¸Ø§Ù… Ø§Ù„ÙˆØ¬ÙˆØ¯ (Presence) ---
        function startPresence() {
            setInterval(() => {
                localStorage.setItem(`presence_${currentUser}`, Date.now());
            }, 2000);

            setInterval(checkOnlineUsers, 3000);
            checkOnlineUsers();
        }

        function checkOnlineUsers() {
            const now = Date.now();
            const online = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('presence_')) {
                    const lastSeen = parseInt(localStorage.getItem(key));
                    const name = key.replace('presence_', '');
                    if (now - lastSeen < 10000) {
                        if (name !== currentUser) online.push(name);
                    }
                }
            }
            
            const textEl = document.getElementById('online-users-text');
            if (online.length > 0) {
                textEl.textContent = `Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†: ${online.join('ØŒ ')}`;
            } else {
                textEl.textContent = `Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø¢Ø®Ø±ÙŠÙ† Ù…ØªØµÙ„ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹`;
            }
        }

        // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Chat) ---
        const STORAGE_KEY = 'huzuri_chat_v1';

        function getMessages() {
            return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        }

        function saveMessages(msgs) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(msgs));
        }

        function renderMessages() {
            const msgs = getMessages();
            const container = document.getElementById('chat-container');
            container.innerHTML = '';

            if (msgs.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #555; margin-top: 50px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯</div>';
                return;
            }

            msgs.forEach(msg => {
                const div = document.createElement('div');
                const isMe = msg.sender === currentUser;
                
                div.className = `message ${isMe ? 'msg-cashier' : 'msg-staff'}`;
                
                let contentHtml = '';
                
                if (msg.type === 'inquiry') {
                    contentHtml = `<img src="${msg.image}" class="msg-img">`;
                    if (userRole === 'staff' && !msg.replied) {
                        contentHtml += `<button class="reply-btn-inline" onclick="openReplyModal(${msg.id})">Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…</button>`;
                    }
                } else if (msg.type === 'reply') {
                    contentHtml = `<div style="margin-bottom:5px; color:#aaa;">Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø³Ø§Ø¨Ù‚</div>`;
                    contentHtml += `
                        <div class="reply-data">
                            Ø§Ù„ÙƒÙˆØ¯: <span>${msg.code}</span><br>
                            Ø§Ù„Ø³Ø¹Ø±: <span>${msg.price}</span>
                        </div>
                    `;
                }

                div.innerHTML = `
                    <span class="msg-sender">${msg.sender} â€¢ ${msg.time}</span>
                    ${contentHtml}
                `;
                container.appendChild(div);
            });

            container.scrollTop = container.scrollHeight;
        }

        function loadMessages() {
            renderMessages();
            window.addEventListener('storage', (e) => {
                if (e.key === STORAGE_KEY) {
                    const oldMsgs = JSON.parse(e.oldValue || '[]');
                    const newMsgs = JSON.parse(e.newValue || '[]');
                    
                    if (newMsgs.length > oldMsgs.length) {
                        const lastMsg = newMsgs[newMsgs.length - 1];
                        if (lastMsg.sender !== currentUser) {
                            playBeep();
                            if(lastMsg.type === 'reply') {
                                alert(`ÙˆØµÙ„ Ø±Ø¯ Ù…Ù† ${lastMsg.sender}\nØ§Ù„ÙƒÙˆØ¯: ${lastMsg.code}\nØ§Ù„Ø³Ø¹Ø±: ${lastMsg.price}`);
                            }
                        }
                    }
                    renderMessages();
                }
            });
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙƒØ§Ø´ÙŠØ± (Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§) ---
        async function openCamera() {
            try {
                const video = document.getElementById('video-feed');
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                document.getElementById('camera-ui').classList.add('active');
            } catch (err) {
                alert('ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + err.message);
            }
        }

        function closeCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            document.getElementById('camera-ui').classList.remove('active');
        }

        function captureAndSend() {
            const video = document.getElementById('video-feed');
            const canvas = document.getElementById('canvas-feed');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const imageData = canvas.toDataURL('image/jpeg');
            
            const msgs = getMessages();
            msgs.push({
                id: Date.now(),
                type: 'inquiry',
                sender: currentUser,
                image: imageData,
                time: new Date().toLocaleTimeString('ar-EG'),
                replied: false
            });
            
            saveMessages(msgs);
            closeCamera();
            renderMessages();
            playBeep();
        }

        // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ÙˆØ¸Ù (Ø§Ù„Ø±Ø¯) ---
        function openReplyModal(msgId) {
            replyingToMsgId = msgId;
            document.getElementById('reply-modal').classList.add('active');
            document.getElementById('reply-code').value = '';
            document.getElementById('reply-price').value = '';
        }

        function closeReplyModal() {
            document.getElementById('reply-modal').classList.remove('active');
            replyingToMsgId = null;
        }

        function sendReply() {
            const code = document.getElementById('reply-code').value;
            const price = document.getElementById('reply-price').value;

            if (!code || !price) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø³Ø¹Ø±');
                return;
            }

            let msgs = getMessages();
            const originalInquiry = msgs.find(m => m.id === replyingToMsgId);
            if (originalInquiry) originalInquiry.replied = true;

            msgs.push({
                id: Date.now(),
                type: 'reply',
                sender: currentUser,
                code: code,
                price: price,
                time: new Date().toLocaleTimeString('ar-EG'),
                repliedTo: replyingToMsgId
            });

            saveMessages(msgs);
            closeReplyModal();
            renderMessages();
            alert('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯ Ù„Ù„ÙƒØ§Ø´ÙŠØ±');
        }

        // --- Ø§Ù„ØµÙˆØª ---
        function playBeep() {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = 1200;
            gain.gain.value = 0.1;
            osc.start();
            setTimeout(() => osc.stop(), 200);
        }

    </script>
</body>
</html>